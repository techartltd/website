<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>Migrate_mch_delivery_discharge</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2020/01/21 14:14:28.716</created_date>
    <modified_user>-</modified_user>
    <modified_date>2020/01/21 14:14:28.716</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>mssql</name>
    <server/>
    <type>MSSQLNATIVE</type>
    <access>JNDI</access>
    <database>mssql</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1521</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>mysql_st</name>
    <server/>
    <type>MYSQL</type>
    <access>JNDI</access>
    <database>mysql_st</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1521</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>Create_st_mch_delivery_discharge</from>
      <to>iqcare_source_mch_delivery_discharge</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>iqcare_source_mch_delivery_discharge</from>
      <to>load_st_mch_delivery_discharge</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Create_st_mch_delivery_discharge</name>
    <type>ExecSQL</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>mysql_st</connection>
    <execute_each_row>N</execute_each_row>
    <single_statement>N</single_statement>
    <replace_variables>N</replace_variables>
    <quoteString>N</quoteString>
    <sql>-- 21_22.  MCH Delivery and Discharge
DROP TABLE IF EXISTS migration_st.st_mch_delivery_discharge;
CREATE TABLE migration_st.st_mch_delivery_discharge
(
  Person_Id                       	    	  	INT(11),
  Encounter_Date                              DATE,
  Encounter_ID                                VARCHAR(50),
  Admission_number			                  VARCHAR(200),
  Gestation_Weeks		        			  INT(50),
  Duration_Labour			                  INT(50),
  Delivery_Mode				                  VARCHAR(200),
  Delivery_Date_Time                          DATE,
  DeliveryTime                                VARCHAR(200),
  Placenta_Complete	   				          VARCHAR(100),
  Blood_Loss_Coded							  VARCHAR(100),
  Blood_Loss							      VARCHAR(100),
  Diagnosis							          VARCHAR(100),
  ManagementPlan							  VARCHAR(100),
  Mother_Condition                            VARCHAR(100),
  Death_Audited				                  VARCHAR(100),
  Death_Audit_Date                            DATE,
  Resuscitation_Done					      VARCHAR(100),
  Delivery_Complications				      VARCHAR(100),
  Delivery_Complications_Type		          VARCHAR(200),
  Delivery_Complications_Other	        	  VARCHAR(255),
  Delivery_Place							  VARCHAR(200),
  Delivery_Conducted_By					      VARCHAR(200),
  Delivery_Cadre							  VARCHAR(100),
  Delivery_Outcome							  VARCHAR(100),
  Baby_Name                                   VARCHAR(200),
  Baby_Sex                                    VARCHAR(100),
  Baby_Weight                                 DOUBLE,
  Baby_Condition                              VARCHAR(200),
  Birth_Deformity                             VARCHAR(200),
  TEO_Birth                                   VARCHAR(100),
  BF_At_Birth_Less_1_hr                       VARCHAR(100),
  Apgar_1                                     INT(50),
  Apgar_5                                     INT(50),
  Apgar_10                                    INT(50),
  Test_1_kit_name                             VARCHAR(50),
  Test_1_kit_lot_no                           VARCHAR(50),
  Test_1_kit_expiry                           DATE,
  Test_1_result                               VARCHAR(50),
  Test_2_kit_name                             VARCHAR(50),
  Test_2_kit_lot_no                           VARCHAR(50),
  Test_2_kit_expiry                           DATE,
  Test_2_result                               VARCHAR(50),
  Final_test_result                           VARCHAR(50),
  Test_Type                                   VARCHAR(50),
  Patient_given_result                        VARCHAR(50),
  Partner_hiv_tested                          VARCHAR(50),
  Partner_hiv_status                          VARCHAR(50),
  Next_HIV_Date                               DATE,
  Syphilis_Tested                             VARCHAR(50),
  Syphilis_Treated                            VARCHAR(50),
  Prophylaxis_given                           VARCHAR(50),
  Baby_azt_dispensed                          VARCHAR(50),
  Baby_nvp_dispensed                          VARCHAR(50),
  Clinical_notes                              TEXT,
  Discharge_Date                              DATE,
  Vitamin_A_Supplimentation                   VARCHAR(50),
  Started_ART_In_ANC                          VARCHAR(50),
  Started_ART_In_Mat                          VARCHAR(50),
  Counselled_Infant_Feeding                   VARCHAR(50),
  Baby_Status_On_Discharge                    VARCHAR(200),
  Mother_Status_On_Discharge                  VARCHAR(200),
  Birth_Notification_Number                   VARCHAR(200),
  Referred_From                               VARCHAR(200),
  Referred_To                                 VARCHAR(200),  
  Next_Appointment_Date                       DATE,
  Appointment_Reason                          VARCHAR(200),
  Voided                                     INT(11)
);
</sql>
    <set_params>N</set_params>
    <insert_field/>
    <update_field/>
    <delete_field/>
    <read_field/>
    <arguments>
    </arguments>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>229</xloc>
      <yloc>124</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>iqcare_source_mch_delivery_discharge</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>mssql</connection>
    <sql>-- 21_22.  MCH Delivery Discharge Validated by DNG

EXEC Pr_opendecryptedsession;
SELECT p.id AS Person_Id,
       d.visitdate AS Encounter_Date,
       NULL AS Encounter_ID,
       h.identifiervalue AS Admission_Number,
       I.gestation AS Gestation_Weeks,
       delivery.durationoflabour AS Duration_Labour,
       delivery.modeofdelivery AS Delivery_Mode,
       delivery.dateofdelivery AS Delivery_Date_Time,
       delivery.timeofdelivery AS DeliveryTime,
       delivery.bloodlossclassification AS Blood_Loss_Coded,
       delivery.bloodlosscapacity AS Blood_Loss,
       delivery.mothercondition AS Mother_Condition,
       delivery.placentacomplete as Placenta_Complete,
       delivery.maternaldeathaudited AS Death_Audited,
       delivery.maternaldeathauditdate as Death_Audit_Date,
       CASE
           WHEN dbbi.resuscitationdone = 1 THEN 'Yes'
           WHEN dbbi.resuscitationdone = 0 THEN 'No'
           ELSE NULL
       END AS Resuscitation_Done,
       delivery.deliverycomplicationsexperienced AS Delivery_Complications,
       NULL AS delivery_Complications_Type,
       delivery.deliverycomplicationnotes AS Delivery_Complications_Other ,
       NULL Delivery_Place,
            delivery.deliveryconductedby AS Delivery_Conducted_By,
            NULL AS Delivery_Cadre,
            NULL AS Delivery_Outcome,
            PatOutcome.datedischarged AS Discharge_Date ,
            NULL Baby_Name,
                 Baby_Sex=
  (SELECT TOP 1 itemname
   FROM [dbo].[lookupitemview]
   WHERE itemid = dbbi.sex),
                 dbbi.birthweight AS Baby_Weight,
                 PatOutcome.outcomestatus AS Baby_Condition,
                 CASE
                     WHEN dbbi.birthdeformity = 0 THEN 'No'
                     WHEN dbbi.birthdeformity = 1 THEN 'Yes'
                     ELSE NULL
                 END AS Birth_Deformity,
                 CASE
                     WHEN dbbi.teogiven = 0 THEN 'No'
                     WHEN dbbi.teogiven = 1 THEN 'Yes'
                     ELSE NULL
                 END AS TEO_Birth,
                 CASE
                     WHEN dbbi.breastfedwithinhr = 0 THEN 'No'
                     WHEN dbbi.breastfedwithinhr = 1 THEN 'Yes'
                     ELSE NULL
                 END AS BF_At_Birth_Less_1_hr,
                 apgar.apgar1min AS Apgar_1,
                 apgar.apgar5min AS Apgar_5,
                 apgar.apgar10min AS Apgar_10,
                 dbbi.birthnotificationnumber as  Birth_Notification_Number,
                 dbbi.birthcomments as ManagementPlan,
                 HIVTest.onekitid AS Test_1_kit_name,
                 HIVTest.onelotnumber AS Test_1_kit_lot_no,
                 HIVTest.oneexpirydate AS Test_1_kit_expiry,
                 HIVTest.finaltestoneresult AS Test_1_result,
                 HIVTest.twokitid AS Test_2_kit_name,
                 HIVTest.twolotnumber AS Test_2_kit_lot_no,
                 HIVTest.twoexpirydate AS Test_2_kit_expiry,
                 HIVTest.finaltesttworesult AS Test_2_result,
                 z.finalresult AS Final_test_Result,
                 HIVTest.testtype AS Test_Type,
                 HIVTest.finalresultgiven AS Patient_given_result,
                 partnerTesting.partnertested AS Partner_hiv_tested,
                 partnerTesting.partnerhivresult AS Partner_hiv_status,
                 NULL AS Next_HIV_Date,
                 tst.finding AS Syphilis_Tested,
                 tss.finding AS Syphilis_Treated, 
                 CTX.ctx AS Prophylaxis_given,
                 [azt for baby] AS Baby_azt_dispensed,
                 [nvp for baby] AS Baby_nvp_dispensed,
                 HAARTMAT.[started haart mat] as Started_ART_In_Mat,
                 HAARTANC.[started haart in anc] as Started_ART_In_ANC ,
                 VITS.[vitaminasupplementation] as Vitamin_A_Supplimentation,
                 TCAs.[description] AS Clinical_notes,
                 TCAs.appointmentdate AS Next_Appointment_Date,
                 d.deleteflag AS Voided 
FROM person p
INNER JOIN patient b ON b.personid = p.id
INNER JOIN patientmastervisit d ON b.id = d.patientid
INNER JOIN
  (SELECT a.patientid,
          enrollmentdate,
          identifiervalue,
          NAME,
          visitdate,
          patientmastervisitid,
          visittype,
          [visitnumber],
          [dayspostpartum]
   FROM patientenrollment a
   INNER JOIN servicearea b ON a.serviceareaid = b.id
   INNER JOIN patientidentifier c ON c.patientid = a.patientid
   INNER JOIN serviceareaidentifiers d ON c.identifiertypeid = d.identifierid
   AND b.id = d.serviceareaid
   INNER JOIN dbo.visitdetails AS g ON a.patientid = g.patientid
   AND b.id = g.serviceareaid
   WHERE b.NAME = 'Maternity') AS h ON b.id = h.patientid
AND d.id = h.patientmastervisitid
LEFT JOIN dbo.pregnancy AS I ON b.id = I.patientid
AND I.patientmastervisitid = h.patientmastervisitid
LEFT JOIN
  (SELECT DISTINCT delivery.deliveryid,
                   [patientmastervisitid],
                   [durationoflabour],
                   [dateofdelivery],
                   [timeofdelivery],
                   lkup2.itemname ModeOfDelivery,
                   lkup3.itemname [PlacentaComplete],
                   [bloodlosscapacity],
                   lkup4.itemname [MotherCondition],
                   lkup.itemname [DeliveryComplicationsExperienced],
                   [deliverycomplicationnotes],
                   [deliveryconductedby],
                   [maternaldeathauditdate],
                   lt.[name] AS MaternalDeathAudited,
                   lkbl.itemname AS [BloodLossClassification]
   FROM dbo.patientdelivery AS delivery
   LEFT JOIN dbo.lookupitemview AS lkup2 ON lkup2.itemid = delivery.[modeofdelivery]
   LEFT JOIN dbo.lookupitemview AS lkup3 ON lkup3.itemid = delivery.[placentacomplete]
   LEFT JOIN dbo.lookupitemview AS lkup4 ON lkup4.itemid = delivery.[mothercondition]
   LEFT JOIN dbo.lookupitemview AS lkup ON lkup.itemid = delivery.[deliverycomplicationsexperienced]
   LEFT JOIN dbo.lookupitemview AS lkbl ON lkbl.itemid = delivery.bloodlossclassification
   LEFT JOIN lookupitem lt ON lt.id = delivery.maternaldeathaudited) delivery ON delivery.patientmastervisitid = d.id
LEFT JOIN dbo.deliveredbabybirthinformation dbbi ON dbbi.patientmastervisitid = d.id
AND delivery.deliveryid = dbbi.deliveryid
LEFT JOIN
  (SELECT b.patientid,
          [patientmastervisitid],
          [datedischarged],
          [OutcomeStatus]=
     (SELECT TOP 1 itemname
      FROM [dbo].[lookupitemview]
      WHERE itemid = a.[outcomestatus]),
          [outcomedescription]
   FROM [dbo].[patientoutcome]a
   INNER JOIN patientmastervisit b ON a.patientmastervisitid = b.id
   WHERE a.deleteflag = 0)PatOutcome ON PatOutcome.patientid = b.id
AND PatOutcome.patientmastervisitid = d.id
LEFT JOIN
  (SELECT deliveredbabybirthinformationid,
          Max(apgar1min)APGAR1min,
          Max(apgar1min)APGAR5min,
          Max(apgar1min)APGAR10min
   FROM
     (SELECT a.id,
             a.[deliveredbabybirthinformationid],
             APGAR1min=
        (SELECT TOP 1 score
         FROM [dbo].[lookupitemview]
         WHERE itemid = a.[apgarscoreid]
           AND itemname = 'Apgar Score 1 min') ,
             APGAR5min=
        (SELECT TOP 1 score
         FROM [dbo].[lookupitemview]
         WHERE itemid = a.[apgarscoreid]
           AND itemname = 'Apgar Score 5 min') ,
             APGAR10min =
        (SELECT TOP 1 score
         FROM [dbo].[lookupitemview]
         WHERE itemid = a.[apgarscoreid]
           AND itemname = 'Apgar Score 10 min')
      FROM [dbo].[deliveredbabyapgarscore] a
      INNER JOIN [dbo].[deliveredbabybirthinformation]b ON a.[deliveredbabybirthinformationid] = b.[id])a GROUP  BY deliveredbabybirthinformationid)apgar ON apgar.deliveredbabybirthinformationid = dbbi.id
LEFT OUTER JOIN ------------------HIV tests

  (SELECT DISTINCT e.personid,
                   Isnull(Cast((CASE e.encountertype
                                    WHEN 1 THEN 'Initial Test'
                                    WHEN 2 THEN 'Repeat Test'
                                END) AS VARCHAR(50)), 'Initial') AS TestType,
                   one.kitid AS OneKitId,
                   one.kitlotnumber AS OneLotNumber ,
                   one.outcome AS FinalTestOneResult,
                   one.encountertype AS encounterone ,
                   two.outcome AS FinalTestTwoResult,
                   one.expirydate AS OneExpiryDate,
                   two.kitid AS twokitid,
                   two.kitlotnumber AS twolotnumber ,
                   two.expirydate AS twoexpirydate,
                   one.encountertype AS encountertwo ,
                   FinalResultGiven =
     (SELECT TOP 1 itemname
      FROM [dbo].[lookupitemview]
      WHERE itemid = e.finalresultgiven)
   FROM testing t
   INNER JOIN [htsencounter] e ON t .htsencounterid = e.id
   LEFT JOIN [dbo].[patientencounter] pe ON pe.id = e.patientencounterid
   INNER JOIN lookupitemview c ON c.itemid = pe.encountertypeid
   LEFT OUTER JOIN
     (SELECT DISTINCT htsencounterid,
                      b.itemname kitid,
                      kitlotnumber,
                      expirydate,
                      personid,
                      l.itemname AS outcome,
                      e.encountertype
      FROM [testing] t
      INNER JOIN [htsencounter] e ON t.htsencounterid = e.id
      INNER JOIN [lookupitemview] l ON l.itemid = t.outcome
      INNER JOIN lookupitemview b ON b.itemid = t.kitid
      INNER JOIN [dbo].[patientencounter] pe ON pe.id = e.patientencounterid
      INNER JOIN lookupitemview c ON c.itemid = pe.encountertypeid
      WHERE e.encountertype = 1
        AND t.testround = 1
        AND c.itemname = 'maternity-encounter') one ON one.personid = e.personid
   FULL OUTER JOIN
     (SELECT DISTINCT htsencounterid,
                      b.itemname kitid,
                      kitlotnumber,
                      expirydate,
                      personid,
                      l.itemname AS outcome,
                      e.encountertype
      FROM [testing] t
      INNER JOIN [htsencounter] e ON t.htsencounterid = e.id
      INNER JOIN [lookupitemview] l ON l.itemid = t.outcome
      INNER JOIN lookupitemview b ON b.itemid = t.kitid
      INNER JOIN [dbo].[patientencounter] pe ON pe.id = e.patientencounterid
      INNER JOIN lookupitemview c ON c.itemid = pe.encountertypeid
      WHERE t.testround = 2
        AND c.itemname = 'maternity-encounter') two ON two.personid = e.personid
   WHERE c.itemname = 'maternity-encounter')HIVTest ON HIVTest.personid = b.personid
LEFT OUTER JOIN
  (SELECT he.personid,
          he.patientencounterid,
          lk.itemname AS FinalResult
   FROM dbo.htsencounter AS he
   INNER JOIN dbo.htsencounterresult AS her ON he.id = her.htsencounterid
   INNER JOIN dbo.patientencounter AS pe ON pe.id = he.patientencounterid
   LEFT OUTER JOIN dbo.lookupitemview AS lk1 ON lk1.itemid = pe.encountertypeid
   LEFT OUTER JOIN dbo.lookupitemview AS lk ON lk.itemid = her.finalresult
   WHERE (lk1.itemname = 'Maternity')) AS z ON z.personid = b.personid
LEFT OUTER JOIN
  (SELECT DISTINCT a.patientid,
                   a.patientmastervisitid,
                   d.itemname [PartnerTested],
                   e.itemname [PartnerHIVResult]
   FROM [dbo].[patientpartnertesting] a
   INNER JOIN dbo.patientencounter b ON a.patientmastervisitid = b.patientmastervisitid
   LEFT OUTER JOIN dbo.lookupitemview c ON c.itemid = b.encountertypeid
   LEFT OUTER JOIN dbo.lookupitemview d ON d.itemid = a.[partnertested]
   LEFT OUTER JOIN dbo.lookupitemview e ON e.itemid = a.[partnerhivresult]
   WHERE (c.itemname = 'maternity-encounter')) partnerTesting ON partnerTesting.patientid = b.id
AND partnerTesting.patientmastervisitid = d.id
LEFT JOIN
  (SELECT b.id PatientId,
          [orderedbydate],
          [reportedbydate],
          [testresults],
          [testresults1],
          [visitdate]
   FROM [dbo].[vw_patientlaboratory] a
   INNER JOIN patient b ON b.ptn_pk = a.ptn_pk
   WHERE testname LIKE '%RPR%'
     AND hasresult = 1)RPRLab ON RPRLab.patientid = b.id
AND RPRLab.orderedbydate = d.[visitdate]
LEFT JOIN
  (SELECT pe.patientid,
          pe.patientmastervisitid,
          pe.examinationtypeid,
          lm.[name] AS ExaminationType,
          pe.examid,
          lt.[name] AS ExaminationName,
          pe.findingid AS FindingId,
          ltf.[name] AS Finding,
          pe.deleteflag,
          pe.createby
   FROM physicalexamination pe
   LEFT JOIN lookupmaster lm ON lm.id = pe.examinationtypeid
   INNER JOIN lookupitem lt ON lt.id = pe.examid
   LEFT JOIN lookupitem ltf ON ltf.id = pe.findingid
   WHERE lt.[name] = 'Treated Syphilis')tss ON tss.patientid = b.id
AND tss.patientmastervisitid = d.id
LEFT JOIN
  (SELECT pe.patientid,
          pe.patientmastervisitid,
          pe.examinationtypeid,
          lm.[name] AS ExaminationType,
          pe.examid,
          lt.[name] AS ExaminationName,
          pe.findingid AS FindingId,
          ltf.[name] AS Finding,
          pe.deleteflag,
          pe.createby
   FROM physicalexamination pe
   LEFT JOIN lookupmaster lm ON lm.id = pe.examinationtypeid
   INNER JOIN lookupitem lt ON lt.id = pe.examid
   LEFT JOIN lookupitem ltf ON ltf.id = pe.findingid
   WHERE lt.[name] = 'Treated For Syphilis') tst ON tst.patientid = b.id
AND tst.patientmastervisitid = d.id
LEFT OUTER JOIN
  (SELECT DISTINCT b.patientid,
                   b.patientmastervisitid,
                   c.[itemname] [CTX]
   FROM dbo.patientdrugadministration b
   INNER JOIN [dbo].[lookupitemview]a ON b.drugadministered = a.itemid
   INNER JOIN [dbo].[lookupitemview]c ON c.itemid = b.value
   WHERE a.itemname = 'Cotrimoxazole')CTX ON CTX.patientid = b.id
AND CTX.patientmastervisitid = d.id
LEFT OUTER JOIN
  (SELECT DISTINCT b.patientid,
                   b.patientmastervisitid,
                   [itemname] [AZT for Baby]
   FROM [dbo].[lookupitemview]a
   INNER JOIN dbo.patientdrugadministration b ON b.value = a.itemid
   WHERE description = 'AZT for the baby dispensed'
     OR description = 'Infant Provided With ARV prophylaxis' )AZTBaby ON AZTBaby.patientid = b.id
AND AZTBaby.patientmastervisitid = d.id
LEFT OUTER JOIN
  (SELECT DISTINCT b.patientid,
                   b.patientmastervisitid,
                   [itemname] [NVP for Baby]
   FROM [dbo].[lookupitemview]a
   INNER JOIN dbo.patientdrugadministration b ON b.value = a.itemid
   WHERE description = 'NVP for the baby dispensed') NVPBaby ON NVPBaby.patientid = b.id
AND NVPBaby.patientmastervisitid = d.id
LEFT JOIN
  (SELECT DISTINCT *
   FROM
     (SELECT *,
             Row_number() OVER(PARTITION BY tc.patientid, tc.patientmastervisitid
                               ORDER BY tc.createdate DESC)rownum
      FROM
        (SELECT [patientmastervisitid],
                [patientid],
                [appointmentdate],
                [AppointmentReason]=
           (SELECT TOP 1 itemname
            FROM [dbo].[lookupitemview]
            WHERE itemid = [reasonid]),
                [description],
                deleteflag,
                createdate
         FROM [dbo].[patientappointment]
         WHERE deleteflag = 0
           AND serviceareaid = 3) tc
      WHERE tc.appointmentreason = 'Follow Up')tc
   WHERE tc.rownum = 1)TCAs ON TCAs.patientid = b.id
AND TCAs.patientmastervisitid = d.id
LEFT JOIN
  (SELECT *
   FROM patientdiagnosis pd
   WHERE (pd.deleteflag IS NULL
          OR pd.deleteflag = 0))pd ON pd.patientmastervisitid = d.id
AND pd.patientid = b.id
LEFT JOIN
  (SELECT DISTINCT b.patientid,
                   b.patientmastervisitid,
                   c.[itemname] [Started HAART in ANC]
   FROM dbo.patientdrugadministration b
   INNER JOIN [dbo].[lookupitemview]a ON b.drugadministered = a.itemid
   INNER JOIN [dbo].[lookupitemview]c ON c.itemid = b.value
   WHERE b.[description] = 'Started HAART in ANC')HAARTANC ON HAARTANC.patientid = b.id
AND HAARTANC.patientmastervisitid = d.id
LEFT OUTER JOIN dbo.patientdiagnosis AS diag ON diag.patientmastervisitid = d.id
LEFT OUTER JOIN dbo.patientvitals AS k ON d.id = k.patientmastervisitid
AND b.id = k.patientid
AND k.visitdate = d.visitdate
LEFT JOIN
  (SELECT DISTINCT b.patientid,
                   b.patientmastervisitid,
                   c.[itemname] [Started HAART MAT]
   FROM dbo.patientdrugadministration b
   INNER JOIN [dbo].[lookupitemview]a ON b.drugadministered = a.itemid
   INNER JOIN [dbo].[lookupitemview]c ON c.itemid = b.value
   WHERE b.[description] = 'ARVs Started in Maternity')HAARTMAT ON HAARTMAT.patientid = b.id
AND HAARTMAT.patientmastervisitid = d.id
LEFT JOIN
  (SELECT DISTINCT b.patientid,
                   b.patientmastervisitid,
                   c.[itemname] [VitaminASupplementation]
   FROM dbo.patientdrugadministration b
   INNER JOIN [dbo].[lookupitemview]a ON b.drugadministered = a.itemid
   INNER JOIN [dbo].[lookupitemview]c ON c.itemid = b.value
   WHERE b.[description] = 'Vitamin A Supplementation')VITS ON VITS.patientid = b.id
AND VITS.patientmastervisitid = d.id
</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>528</xloc>
      <yloc>128</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>load_st_mch_delivery_discharge</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>mysql_st</connection>
    <schema>migration_st</schema>
    <table>st_mch_delivery_discharge</table>
    <commit>1000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>896</xloc>
      <yloc>128</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
